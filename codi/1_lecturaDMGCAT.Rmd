---
title: "Prevalença de diabetis gestacional i d’alteracions glucèmiques en el postpart a Catalunya. Estudi eDMGCAT"
author: "Jordi Real & Ramó Puig"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
    in_header: header.html
      
params:
  dir_dades_origen: "../../DADES/epiDMGCAT/mostra"
  dir_dades: "dades/mostra"
---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"text-align: center;margin:auto;width: 80px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

```{r htmltemplate, echo=FALSE}
# ![](logoDAP_Cat.png)

# htmltools::img(src = knitr::image_uri(file.path("logos_css", "logo.jpg")), 
#                alt = 'logo', 
#                style = 'position:absolute; top:-90px; right:1%; padding:5px;')

img<-htmltools::img(src = knitr::image_uri(file.path("logos_css", "logo.jpg")), 
               alt = 'logo', 
               style = 'position:absolute; text-align: center;padding-right:150px;width: 185px;padding:10px;')

# src="https://www.idiapjgol.org/images/logo.png" 
# style= 'float: right ;width: 130px'
# 
# src="https://avatars2.githubusercontent.com/u/57066591?s=200&v=4"
# style = 'text-align: center;;margin:auto;width: 80px'

# padding-left:30px

htmlhead <- paste0('
  <script>
  document.write(\'<div class="logos">',img,'</div>\')
  </script>
  ')

readr::write_lines(htmlhead, path = "header.html")

```


## 0. Estat:

**Últimes actualizacions** 

&check; Lectura de fitxers  <br/>
&check;   <br/>

**Realizat**


&check; ....  <br/>
&check; ....   <br/>


**Pendent**

* Exploratori 
* Revisió i depuració d'errors 
* Edició de taules 

## 1. Objectius

1. Conèixer la prevalença anual de DMG i comparar les característiques basals de les gestants amb DMG amb les de les gestants sense DMG.
2. Determinar el percentatge de les alteracions glucèmiques en el postpart. 

Calcular el risc relatiu de complicacions relacionades amb l’embaràs, el part i del recent nascut en les dones amb DMG en comparació amb les dones sense DMG

## 2. Mètodes

Metodologia:
Fase I: Estudi transversal per determinar l’objectiu 1
Fase II: Estudi de cohorts retrospectiu per determinar l’objectiu 2.
S’inclouran totes les gestants a qui se’ls ha realitzat el cribratge de DMG entre 2010-2019.


## 3. Determinacions

La informació clínica, analítica i de tractament farmacològic s’obtindrà de la base de dades SIDIAP que inclou la informació de la història clínica informatitzada a l’atenció primària (e_CAP).

## 4. Anàlisi estadístic

Es descriu el perfil demogràfic i clínic dels pacients inclosos emprenant els estadístics més adeqüats en cada cas en funció del tipus de variable. Es descriu el perfil demogràfic i clínic dels professionals inclosos emprenant els estadístics més adeqüats en cada cas en funció del tipus de variable.I es mira la seva mobilitat, respecte la seva edat i malalties cardiovasculars.



```{r setup, include = F}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")
library(ggplot2)
library(dplyr)
# Carrego funcions -------------------
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

source("funcions_DMG.R")

#   template: template.html
```


# FASE LECTURA

>> Generació de taula plana i aplicació de primers criteris d'inclusió 


```{r lectura}


directori_dades_origen<-params$dir_dades_origen
directori_dades<-params$dir_dades

conductor_codis<-here::here("cataleg_epiDMG.xlsx")
dt_cataleg<-readxl::read_excel(conductor_codis,col_types = "text")

##############################################################################
#
##i)   EPIDMGCAT_entregable_poblacio_20210222_142117
#ii)  EPIDMGCAT_entregable_variables_assir_20210222_142117
##iii) EPIDMGCAT_entregable_variables_analitiques_20210222_142117
##iv)  EPIDMGCAT_entregable_cmbdh_diagnostics_20210222_142117
##v)   EPIDMGCAT_entregable_diagnostics_20210222_142117
##vi)  EPIDMGCAT_entregable_farmacs_facturats_20210222_142117
#vii) EPIDMGCAT_entregable_farmacs_prescrits_20210222_142117
##viii)EPIDMGCAT_entregable_variables_cliniques_20210222_142117
#ix)  EPIDMGCAT_entregable_variables_geosanitaries_20210222_142117
##x)   EPIDMGCAT_entregable_variables_socioeconomiques_20210222_142117
#
##############################################################################
#i)
dt_poblacio<-readRDS(here::here(directori_dades_origen,"EPIDMGCAT_entregable_poblacio_20210222_142117.rds"))
#ii)
dt_vars_assir<-readRDS(here::here(directori_dades_origen,"EPIDMGCAT_entregable_variables_assir_20210222_142117.rds" )) 
#iii)
dt_analitiques<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_variables_analitiques_20210222_142117.rds" )) 
#iv)
dt_diagnostics_HOSP<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_cmbdh_diagnostics_20210222_142117.rds" )) 
#v)
dt_diagnostics_AP<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_diagnostics_20210222_142117.rds" )) 
#vi)
dt_farmacs_facturats<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_farmacs_facturats_20210222_142117.rds" )) 
#vii)
dt_farmacs_prescrits<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_farmacs_prescrits_20210222_142117.rds" )) 
#viii)
dt_cliniques<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_variables_cliniques_20210222_142117.rds" )) 
#ix)
dt_geosanitaries<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_variables_geosanitaries_20210222_142117.rds" )) 
#x)
dt_socioeconomiques<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_variables_socioeconomiques_20210222_142117.rds" )) 

dt_diagnostics_AP_HOSP<-dt_diagnostics_AP%>%transmute(idp,cod=as.character(cod),dat,agr)%>%
  bind_rows(select(dt_diagnostics_HOSP,idp,cod,dat,agr))




```

```{r agregacio1, include=F}

#agregacio poblacio ------------

#i)
#Patologies Previes! [cap -INF]
dtagr_poblacio<-dt_poblacio


```


```{r agregacio2, include=F}

#agregacio Problemes de salut ------------

#ii)
#Patologies Previes! [cap -INF]
dtagr_diagnostics_AP_HOSP<-agregar_problemes(select(dt_diagnostics_AP_HOSP,idp,cod,dat),
                                        bd.dindex ="20191231",
                                        dt.agregadors=select(dt_cataleg,cod,agr),
                                        finestra.dies=c(-Inf,0),prefix = "DG.")


```



```{r agregacio3, include=F}

#agregacio facturacio ------------

#iii)
dt_facturacio<-dt_farmacs_facturats %>% transmute(idp,cod,dat,env)
#
dtagr_facturacio<-agregar_facturacio(
  dt=dt_facturacio,
  bd.dindex="20191231",
  finestra.dies=c(-90,0),
  dt.agregadors=select(dt_cataleg,cod,agr=agr),
  prefix="FF.",
  camp_agregador="agr",
  agregar_data=T)


dtagr_prescrip<-agregar_prescripcions(
  dt=dt_farmacs_prescrits,
  dt.agregadors=select(dt_cataleg,cod,agr),
  prefix="FP.",
  bd.dindex=20191231,
  finestra.dies=c(-Inf,0),
  camp_agregador="agr",
  agregar_data=T) 






```

```{r depuracio_dades_origen, eval=FALSE}
# Eliminar accents i caracters estrants de camps origen
# dt_origen<-read.csv2(here::here("dades","DMG_Origen.csv"))

# dt_vars_assir<-readRDS(here::here(params$dir_dades_origen,"EPIDMGCAT_entregable_variables_assir_20210222_142117.rds" )) 

# dt_vars_assir<-readRDS(here::here("../DADES/epiDMGCAT/SIDIAP","EPIDMGCAT_entregable_variables_assir_20210222_142117.rds" )) 
dt_origen<- dt_vars_assir %>% 
  filter(cod%in%c("PACR003","PACR004")) %>% 
  netejar_val_txt() %>% 
  select(cod,val_txt) %>% distinct() 
  

dt_origen <- dt_origen %>% select(cod,val_txt) %>% distinct() 

# numerar 
dt_origen<-dt_origen %>% arrange(cod,val_txt) %>%  transmute(id=1:n(),cod,val_txt)  

# dt_origen %>% filter(cod%in%c("PACR003","PACR004")) %>% 
#   mutate(val_txt=stringi::stri_trans_general(val_txt, id="Latin-ASCII")) %>% 
#   select(cod,val_txt) %>% distinct()


# write.csv2(dt_origen,"dt_orgigen.csv")

# Netejar caracters extranys d'origen Base de dades 
dt_vars_assir<-netejar_val_txt(dt_vars_assir)



```



```{r agregacio4, include=F}

#iv) agregacio Analitiques+ Cliniques ------------
# data mes propera!
# analatiques
dt_variables<-dt_analitiques%>% bind_rows(dt_cliniques) %>% select(-agr) %>% 
  left_join(select(dt_cataleg,cod,agr),by="cod") %>% 
  select(-cod) %>% rename(cod=agr)

dtagr_variables<-agregar_analitiques(dt=dt_variables,bd.dindex="20191231",finestra.dies = c(-365,0))

```


```{r agregacio5, include=F}

#agregacio socioeconomiques ------------

#v)
#Patologies Previes! [cap -INF]
dtagr_socioeconomiques<-dt_socioeconomiques


```


```{r agregacio6, include=F}

#agregacio dt_geosanitaries ------------

#vi)
#dt_geosanitaries ??
#dtagr_geosanitaries<-dt_geosanitaries


```

```{r agregacio7, include=F}

#agregacio vars_assir ------------

#vii)
#vars_assir ??
#dtagr_vars_assir<-dt_vars_assir


```



```{r fusio}

#left_join(select(dtagr_problemes_2018_EPIPEU_AP_HOSP2b,-dtindex),by="idp")

dt_plana<-dtagr_poblacio %>%
 left_join(dtagr_socioeconomiques,by="idp")%>%  
  left_join(dtagr_diagnostics_AP_HOSP,by="idp")%>%
   left_join(select(dtagr_facturacio,-dtindex),by="idp")%>%
    left_join(select(dtagr_prescrip,-dtindex),by="idp")%>%
     left_join(select(dtagr_variables,-dtindex),by="idp")

```


## 2. Salvar dades 

```{r salvar_dtplana, include=T}

saveRDS(dt_plana, file=here::here(directori_dades,"dt_plana.rds"))



```


&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Ray Puig$</a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



